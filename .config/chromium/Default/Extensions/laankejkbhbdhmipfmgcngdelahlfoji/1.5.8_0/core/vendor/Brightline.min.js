!function(e,t){var n=function(e){if("object"==typeof e&&null!==e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}return"undefined"==typeof e||null===e||""===e},i=function(e,t){for(var n=0;n<t.length;n++)if(e===t[n])return!0;return!1},s=function(e){return"object"==typeof e&&null!==e&&"number"==typeof e.length},o=function(e){return"object"==typeof e&&null!==e&&"number"!=typeof e.length},a=function(e,t,n){t="undefined"==typeof t?[]:t,n="undefined"==typeof n?{}:n;var r,i,s;for(var o in e)e.hasOwnProperty(o)&&(r=o,i=e[o],t.push(r),"object"==typeof i&&null!==i?n=a(i,t,n):(s=t.join("."),n[s]=i),t.pop());return n},h=function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e,arguments)}};var l=function(e){this.name=e,this.content="",this.touched=0,this.variables=[],this.parsedContent=[],this.variableCache={},this.usedVariables={}};l.prototype={NODE_ID:null,name:null,content:null,touched:null,variables:null,parsedContent:null,variableCache:null,usedVariables:null,reset:function(){this.parsedContent=[],this.usedVariables={},this.touched=0},isAlreadyParsed:function(e){return e in this.usedVariables},getName:function(){return this.name},getParsedContent:function(){return this.parsedContent},addParsedContent:function(e){this.parsedContent.push(e)},setParsedContent:function(e){this.parsedContent=e},getContent:function(){return this.content},setContent:function(e){this.content=e},setVariables:function(e){this.variables=e},getVariables:function(){return this.variables},setTouched:function(e){this.touched=e},touch:function(){this.touched+=1},getTouched:function(){return this.touched},getVariableCache:function(){return this.variableCache},setUsedVariable:function(e,t){this.usedVariables[e]=t},getNodeID:function(){return this.getName()}};var c=function(){this.childParentMap={},this.nodes={},this.numNodes=0,this.tree={}};c.prototype={childParentMap:null,nodes:null,numNodes:null,tree:null,log:function(e,t,n,r){},addNode:function(e,t){this.nodes[t]=e,this.numNodes+=1},getNode:function(e){return this.hasNode(e)?this.nodes[e]:null},getNodes:function(e){if(e){for(var t={},n=0;n<e.length;n++)t[e[n]]=this.getNode(e[n]);return t}return this.nodes},removeNode:function(e){if(this.hasNode(e)){try{delete this.nodes[e]}catch(n){this.nodes[e]=t}this.numNodes-=1}},hasNode:function(e){return e in this.nodes},isEmpty:function(){for(var e in this.nodes)if(this.nodes.hasOwnProperty(e))return!1;return!0},has:function(e){return this.hasNode(e)},getNodeID:function(e){if("string"==typeof e||"number"==typeof e)return e;if("object"==typeof e&&null!==e&&"function"==typeof e.getNodeID)return e.getNodeID();throw new Error("[Tree.getNodeID()] Cannot get node ID")},addChild:function(e,t){var n=this.getNodeID(e),r=this.getNodeID(t);if(this.hasParent(t))throw new Error("[Tree.addChild()] Child node "+r+" already has a parent");if(n===r)throw new Error("[Tree.addChild()] Parent and child node are the same. You cannot add a parent node as a child of itself, or vice-versa.");if(this.hasNode(r))throw new Error("[Tree.addChild()] The nodeID "+r+" is already in use");this.hasNode(n)||this.addNode(e,n),this.log("addChild","Adding child",{parent:e,child:t},"DEBUG"),this.addNode(t,r),n in this.tree||(this.tree[n]=[]),this.tree[n].push(r),this.childParentMap[r]=n},addChildren:function(e,t){if(!s(t))throw new Error("[Tree.addChildren()] Children added to Tree must in an array");for(var n=0;n<t.length;n++)this.addChild(e,t[n])},getChild:function(e){if(!this.hasNode(e))throw new Error("[Tree.getChild()] Cannot get non-existent node "+e+" from Tree");return this.getNode(e)},getChildren:function(e){var t=this.getNodeID(e);return t in this.tree?this.getNodes(this.tree[t]):{}},hasChild:function(e,t){var n=this.getNodeID(e),r=this.getNodeID(t);return r in this.childParentMap&&n===this.childParentMap[r]},hasChildren:function(e){var t=this.getNodeID(e);return t in this.tree&&this.tree[t].length>0},removeChild:function(e,n){if(!this.isChildOf(e,n))throw new Error("[Tree.removeChild()] Cannot remove child. This node is not a child of the given parent.");for(var r=this.getNodeID(e),i=this.getNodeID(n),s=this.tree[r],o=0;o<s.length;o++)if(s[o]===i){s.splice(o,1);break}try{delete this.childParentMap[i]}catch(e){this.childParentMap[i]=t}if(0===s.length)try{delete this.tree[r]}catch(e){this.tree[r]=t}this.removeNode(i),this.hasChildren(i)&&this.removeChildren(i)},removeChildren:function(e,t){"undefined"==typeof t&&this.hasChildren(e)&&(t=this.getChildren(e));for(var n in t)t.hasOwnProperty(n)&&this.removeChild(e,t[n])},isChildOf:function(e,t){return this.hasChild(e,t)},addParent:function(e){if(!this.isEmpty())throw new Error("[Tree.addParent()] Cannot add lone parent to a Tree that already has nodes in it. Use Tree.addChild(parent,child) instead.");var t=this.getNodeID(e);if(this.hasNode(t))throw new Error("[Tree.addParent()] Parent's node id must be unique.");this.addNode(e,t),t in this.tree||(this.tree[t]=[])},getParent:function(e){if(!this.hasParent(e))return!1;var t=this.getParentNodeID(e);return this.getNode(t)},hasParent:function(e){var t=this.getParentNodeID(e);return null!==t},getParentNodeID:function(e){var t=null;if(("string"==typeof e||"number"==typeof e)&&e in this.childParentMap)t=this.childParentMap[e];else if("object"==typeof e&&null!==e&&"function"==typeof e.getNodeID){var n=e.getNodeID();t=n in this.childParentMap?this.childParentMap[n]:null}return t},isParent:function(e){return this.hasChildren(e)},remove:function(e){var t=this.getNodeID(e);if(this.hasParent(t)){var n=this.getParent(t);this.removeChild(n,e)}else this.isParent(e)&&this.removeChildren(e);this.removeNode(t)}};var d=function(e,t){return this.blocks=new c,this.currentBlock=null,this.currentScope=null,this.usedVariables={},this.variableCache={},o(t)&&(r=t.logLevel||"ERROR",this.name=t.name||null),"string"==typeof e&&this.process(e),this.getAPI()};d.prototype={blocks:null,currentBlock:null,currentScope:null,name:null,usedVariables:null,variableCache:null,getAPI:function(){return{set:this.set.bind(this),setScope:this.setScope.bind(this),clearScope:this.clearScope.bind(this),touch:this.touch.bind(this),parse:this.parse.bind(this),render:this.render.bind(this),snip:this.snip.bind(this),setLogLevel:this.setLogLevel.bind(this),setName:this.setName.bind(this),each:this.each.bind(this)}},setLogLevel:function(e){r=e},setName:function(e){this.name=e},log:function(e,t,n,r){},set:function(){var e=Array.prototype.slice.call(arguments),t=null,n=null,r=!1;return o(e[0])?(t=e[0],r=e[1],this.setObjectVars(t,r)):(t=e[0],n=e[1],r=e[2],"function"==typeof n?n=n():"undefined"==typeof n&&(n=null),this.isValidKeyValuePair(t,n)&&(null===this.currentScope||r?this.variableCache[t]=n:this.currentScope.variableCache[t]=n)),this},each:function(){var e=Array.prototype.slice.call(arguments),t=e[0],n=e[1],r=null,i=null;"string"==typeof e[2]?r=e[2]:"function"==typeof e[2]&&(i=e[2]),!i&&"function"==typeof e[3]&&(i=e[3]);for(var s in t)t.hasOwnProperty(s)&&(o(t[s])?this.set(t[s]):r&&this.set(r,t[s]),i&&i(t[s],s),this.parse(n))},setScope:function(e){if(!this.hasBlock(e))throw new Error("["+this.name+" Brightline.setScope()] Cannot set scope to non-existent block: "+e);return this.currentScope=this.getBlock(e),this},clearScope:function(e){return e="undefined"==typeof e||e,!e&&null!==this.currentScope&&(this.currentScope.variableCache={},this.currentScope.usedVariables={}),e&&(this.currentScope=null),this},touch:function(e){var t=this.getBlock(e);return t.touch(),this},parse:function(e,t){e="undefined"==typeof e?"__root__":e,t="undefined"==typeof t||t;var n=this.getBlock(e);return t?n.setTouched(1):n.setTouched(0),this.currentBlock=n.getName(),this.parseBlock(n),this.clearUsedVariablesFromCache(),this.clearScope(!1),n.setTouched(0),this.currentBlock="__root__",n},render:function(e){e="undefined"==typeof e?"__root__":e;var t=this.parse(e),n=h(t.getParsedContent().join("\n"));return this.clearScope(),t.reset(),n},snip:function(e){e="undefined"==typeof e?"__root__":e;var t=this.parse(e,!1),n=t.getParsedContent(),r=h(n.join("\n"));return 0===r.length&&(r=t.getContent()),n=n.slice(0,0-t.getTouched()),t.setParsedContent(n),this.clearScope(),r},setObjectVars:function(e,t){var n=a(e);for(var r in n)n.hasOwnProperty(r)&&this.set(r,n[r],t)},getBlock:function(e){if(!this.hasBlock(e))throw new Error("["+this.name+" Brightline.getBlock()] Cannot get non-existent block: "+e);return this.blocks.getChild(e)},hasBlock:function(e){return this.blocks.has(e)},process:function(e){var t=new l("__root__");t.setContent(e),this.findBlocks(t),this.insertChildBlockPlaceholders(t),this.findVariablesInBlockContent(t),this.blocks.has("__root__")||this.blocks.addParent(t)},findBlocks:function(e){var t=/<!--\s+BEGIN\s+([\.0-9A-Za-z:|_-]+)\s+-->([\s\S]*)<!--\s+END\s+\1\s+-->/gm,n=e.getContent(),r=n.match(t),i=this;if(r)for(var s=0;s<r.length;s++){var o=new RegExp(t).exec(r[s]);if(o){var a=o[1],h=new l(a);if(h.setContent(o[2]),i.blocks.has(a))throw new Error("["+this.name+" Brightline.findBlocks()] Duplicate block name: "+a+". Block names must be unique.");i.blocks.addChild(e,h),i.findBlocks(h),i.insertChildBlockPlaceholders(h),i.findVariablesInBlockContent(h)}}},insertChildBlockPlaceholders:function(e){if(this.blocks.hasChildren(e)){var t=this.blocks.getChildren(e);for(var n in t)t.hasOwnProperty(n)&&function(t){var n=t.getName(),r=e.getContent(),i="<!--\\s+BEGIN\\s+"+n+"\\s+-->([\\s\\S]*)<!--\\s+END\\s+"+n+"\\s+-->",s=r.match(i);s&&e.setContent(r.replace(s[0],"{{__"+n+"__}}"))}(t[n])}},findVariablesInBlockContent:function(e){var t=/(?!\{{__[\.0-9A-Za-z\*:|_-]+__\}})\{{([\.0-9A-Za-z\*:|_-]+)\}}/gm,n=[],r=e.getContent().match(t);if(r){for(var s=0;s<r.length;s++)if(!i(n,r[s])){var o=r[s].replace("{{","").replace("}}","");n.push(o)}e.setVariables(n)}},parseBlock:function(e){var t=this.blocks.getChildren(e);for(var n in t)t.hasOwnProperty(n)&&this.parseBlock(t[n]);return this.currentBlock=e.getName(),this.replaceBlockVariables(e),this.replaceChildBlockPlaceholders(e),e.setTouched(0),e},replaceBlockVariables:function(e){var t=e.getContent(),n=e.getVariables(),r=e.getName(),i=e.getVariableCache();if(n.length>0)for(var s=0;s<n.length;s++){var o=n[s],a="{{"+o+"}}";r===this.currentBlock?o in i?(t=t.replace(a,i[o]),e.setUsedVariable(o,!0),e.touched=1):o in this.variableCache&&!e.isAlreadyParsed(o)?(t=t.replace(a,this.variableCache[o]),this.usedVariables[o]=!0,e.touched=1):t=t.replace(a,""):t=t.replace(a,"")}for(var h=e.getTouched(),l=0;l<h;l++)e.addParsedContent(t)},replaceChildBlockPlaceholders:function(e){var t=this.getParsedContent(e),r=this.blocks.getChildren(e);if(!n(r)){for(var i in r)if(r.hasOwnProperty(i)){var s="{{__"+r[i].getName()+"__}}",o=h(r[i].parsedContent.join(""));for(var a in t)t.hasOwnProperty(a)&&t[a].indexOf(s)>-1&&(t[a]=t[a].replace(s,o));r[i].parsedContent=[]}e.setParsedContent(t)}},getParsedContent:function(e){if(0===e.parsedContent.length&&this.blocks.hasChildren(e)){var t=this.blocks.getChildren(e);for(var n in t)if(t.hasOwnProperty(n)&&t[n].parsedContent.length>0){this.touch(e.getName()),this.replaceBlockVariables(e);break}}return e.getParsedContent()},clearUsedVariablesFromCache:function(){for(var e in this.usedVariables)if(this.usedVariables.hasOwnProperty(e))try{delete this.variableCache[e]}catch(n){this.variableCache[e]=t}this.usedVariables=[]},isValidKeyValuePair:function(e,t){return"string"==typeof e&&("string"==typeof t&&t.length>0||"number"==typeof t||"boolean"==typeof t)}},"function"==typeof define?define(function(){return d}):e.Brightline=d}(window);